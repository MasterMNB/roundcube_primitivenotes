CKEDITOR.dialog.add("base64imageDialog",function(f){function C(a){if("string"!=typeof a||!a){k.getElement().setHtml("")}else{var c=new Image;k.getElement().setHtml("Loading...");c.onload=function(){k.getElement().setHtml("");null==w||null==v?(g.setValueOf("tab-properties","width",this.width),g.setValueOf("tab-properties","height",this.height),x=1,0<this.height&&0<this.width&&(x=this.width/this.height),0>=x&&(x=1)):v=w=null;this.id=f.id+"previewimage";this.setAttribute("style","max-width:400px;max-height:100px;");this.setAttribute("alt","");try{var d=k.getElement().$;d&&d.appendChild(this)}catch(e){}};c.onerror=function(){k.getElement().setHtml("")};c.onabort=function(){k.getElement().setHtml("")};c.src=a}}function A(d){k.getElement().setHtml("");if("base64"==d){y&&y.setValue(!1,!0),z&&z.setValue(!1,!0)}else{if("url"==d){y&&y.setValue(!0,!0),z&&z.setValue(!1,!0),D&&C(D.getValue())}else{if(E){y&&y.setValue(!1,!0);z&&z.setValue(!0,!0);var e=g.getContentElement("tab-source","file"),d=null;try{d=e.getInputElement().$}catch(c){d=null}if(d&&("files" in d&&d.files&&0<d.files.length&&d.files[0])&&(!("type" in d.files[0])||d.files[0].type.match("image.*"))&&FileReader){k.getElement().setHtml("Loading..."),e=new FileReader,e.onload=function(){return function(a){k.getElement().setHtml("");C(a.target.result)}}(d.files[0]),e.onerror=function(){k.getElement().setHtml("")},e.onabort=function(){k.getElement().setHtml("")},e.readAsDataURL(d.files[0])}}}}}function F(h){var l=g.getContentElement("tab-properties","width").getValue(),d=g.getContentElement("tab-properties","height").getValue(),i="px",m="px";0<=l.indexOf("%")&&(i="%");0<=d.indexOf("%")&&(m="%");l=parseInt(l,10);d=parseInt(d,10);isNaN(l)&&(l=0);isNaN(d)&&(d=0);var j="px";"width"==h?("%"==i&&(j="%"),d=Math.round(l/x)):("%"==m&&(j="%"),l=Math.round(d*x));"%"==j&&(l+="%",d+="%");g.getContentElement("tab-properties","width").setValue(l);g.getContentElement("tab-properties","height").setValue(d)}function G(e){var d=e.getValue(),h="";0<=d.indexOf("%")&&(h="%");d=parseInt(d,10);isNaN(d)&&(d=0);e.setValue(d+h)}var g=null,b=null,w=null,v=null,k=null,y=null,D=null,z=null,x=1,B=!0,E=function(){var e=!1,h=null;try{FileReader&&(h=document.createElement("input"))&&"files" in h&&(e=!0)}catch(i){e=!1}return e}(),H=E?[{type:"hbox",widths:["70px"],children:[{type:"checkbox",id:"urlcheckbox",style:"margin-top:5px",label:f.lang.common.url+":"},{type:"text",id:"url",label:"",onChange:function(){A("url")}}]},{type:"hbox",widths:["70px"],children:[{type:"checkbox",id:"filecheckbox",style:"margin-top:5px",label:f.lang.common.upload+":"},{type:"file",id:"file",label:"",onChange:function(){A("file")}}]},{type:"html",id:"preview",html:(new CKEDITOR.template('<div style="text-align:center;"></div>')).output()}]:[{type:"text",id:"url",label:f.lang.common.url,onChange:function(){A("url")}},{type:"html",id:"preview",html:(new CKEDITOR.template('<div style="text-align:center;"></div>')).output()}];return{title:f.lang.common.image,minWidth:450,minHeight:180,onLoad:function(){E&&(y=this.getContentElement("tab-source","urlcheckbox"),z=this.getContentElement("tab-source","filecheckbox"),y.getInputElement().on("click",function(){A("url")}),z.getInputElement().on("click",function(){A("file")}));D=this.getContentElement("tab-source","url");k=this.getContentElement("tab-source","preview");this.getContentElement("tab-properties","lock").getInputElement().on("click",function(){(B=this.getValue()?true:false)&&F("width")},this.getContentElement("tab-properties","lock"));this.getContentElement("tab-properties","width").getInputElement().on("keyup",function(){B&&F("width")});this.getContentElement("tab-properties","height").getInputElement().on("keyup",function(){B&&F("height")});this.getContentElement("tab-properties","vmargin").getInputElement().on("keyup",function(){G(this)},this.getContentElement("tab-properties","vmargin"));this.getContentElement("tab-properties","hmargin").getInputElement().on("keyup",function(){G(this)},this.getContentElement("tab-properties","hmargin"));this.getContentElement("tab-properties","border").getInputElement().on("keyup",function(){G(this)},this.getContentElement("tab-properties","border"))},onShow:function(){k.getElement().setHtml("");g=this;v=w=null;x=1;B=!0;(b=f.getSelection())&&(b=b.getSelectedElement());if(!b||"img"!==b.getName()){b=null}g.setValueOf("tab-properties","lock",B);g.setValueOf("tab-properties","vmargin","0");g.setValueOf("tab-properties","hmargin","0");g.setValueOf("tab-properties","border","0");g.setValueOf("tab-properties","align","none");if(b){"string"==typeof b.getAttribute("width")&&(w=b.getAttribute("width"));"string"==typeof b.getAttribute("height")&&(v=b.getAttribute("height"));if((null==w||null==v)&&b.$){w=b.$.width,v=b.$.height}null!=w&&null!=v&&(g.setValueOf("tab-properties","width",w),g.setValueOf("tab-properties","height",v),w=parseInt(w,10),v=parseInt(v,10),x=1,!isNaN(w)&&(!isNaN(v)&&0<v&&0<w)&&(x=w/v),0>=x&&(x=1));"string"==typeof b.getAttribute("src")&&(0===b.getAttribute("src").indexOf("data:")?(A("base64"),C(b.getAttribute("src"))):g.setValueOf("tab-source","url",b.getAttribute("src")));"string"==typeof b.getAttribute("alt")&&g.setValueOf("tab-properties","alt",b.getAttribute("alt"));"string"==typeof b.getAttribute("hspace")&&g.setValueOf("tab-properties","hmargin",b.getAttribute("hspace"));"string"==typeof b.getAttribute("vspace")&&g.setValueOf("tab-properties","vmargin",b.getAttribute("vspace"));"string"==typeof b.getAttribute("border")&&g.setValueOf("tab-properties","border",b.getAttribute("border"));if("string"==typeof b.getAttribute("align")){switch(b.getAttribute("align")){case"top":case"text-top":g.setValueOf("tab-properties","align","top");break;case"baseline":case"bottom":case"text-bottom":g.setValueOf("tab-properties","align","bottom");break;case"left":g.setValueOf("tab-properties","align","left");break;case"right":g.setValueOf("tab-properties","align","right")}}g.selectPage("tab-properties")}},onOk:function(){var a="";try{a=CKEDITOR.document.getById(f.id+"previewimage").$.src}catch(d){a=""}if(!("string"!=typeof a||null==a||""===a)){var c=b?b:f.document.createElement("img");c.setAttribute("src",a);c.setAttribute("alt",g.getValueOf("tab-properties","alt").replace(/^\s+/,"").replace(/\s+$/,""));var a={width:["width","width:#;","integer",1],height:["height","height:#;","integer",1],vmargin:["vspace","margin-top:#;margin-bottom:#;","integer",0],hmargin:["hspace","margin-left:#;margin-right:#;","integer",0],align:["align",""],border:["border","border:# solid black;","integer",0]},n=[],l,m,o,p;for(p in a){m=o=l=g.getValueOf("tab-properties",p);unit="px";if("align"==p){switch(l){case"top":case"bottom":a[p][1]="vertical-align:#;";break;case"left":case"right":a[p][1]="float:#;";break;default:l=null}}"integer"==a[p][2]&&(0<=l.indexOf("%")&&(unit="%"),l=parseInt(l,10),isNaN(l)?l=null:l<a[p][3]&&(l=null),null!=l&&("%"==unit?(o=l+"%",m=l+"%"):(o=l,m=l+"px")));null!=l&&(c.setAttribute(a[p][0],o),n.push(a[p][1].replace(/#/g,m)))}0<n.length&&c.setAttribute("style",n.join(""));b||f.insertElement(c);f.plugins.imageresize&&f.plugins.imageresize.resize(f,c,800,800)}},contents:[{id:"tab-source",label:f.lang.common.generalTab,elements:H},{id:"tab-properties",label:f.lang.common.advancedTab,elements:[{type:"text",id:"alt",label:f.lang.base64image.alt},{type:"hbox",widths:["15%","15%","70%"],children:[{type:"text",width:"45px",id:"width",label:f.lang.common.width},{type:"text",width:"45px",id:"height",label:f.lang.common.height},{type:"checkbox",id:"lock",label:f.lang.base64image.lockRatio,style:"margin-top:18px;"}]},{type:"hbox",widths:["23%","30%","30%","17%"],style:"margin-top:10px;",children:[{type:"select",id:"align",label:f.lang.common.align,items:[[f.lang.common.notSet,"none"],[f.lang.common.alignTop,"top"],[f.lang.common.alignBottom,"bottom"],[f.lang.common.alignLeft,"left"],[f.lang.common.alignRight,"right"]]},{type:"text",width:"45px",id:"vmargin",label:f.lang.base64image.vSpace},{type:"text",width:"45px",id:"hmargin",label:f.lang.base64image.hSpace},{type:"text",width:"45px",id:"border",label:f.lang.base64image.border}]}]}]}
});