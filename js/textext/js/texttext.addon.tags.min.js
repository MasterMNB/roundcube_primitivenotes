(function(t){function e(){}t.fn.textext.TextExtTags=e,t.fn.textext.addPlugin("tags",e);var n=e.prototype,a=".",o="text-tags-on-top",i=a+o,s="text-tag",r=a+s,l="text-tags",g=a+l,d="text-label",c=a+d,u="text-remove",f=a+u,m="tags.enabled",p="tags.items",v="html.tag",h="html.tags",x="isTagAllowed",T="tagClick",I={tags:{enabled:!0,items:null},html:{tags:'<div class="text-tags"/>',tag:'<div class="text-tag"><div class="text-button"><span class="text-label"/><a class="text-remove"/></div></div>'}};n.init=function(e){this.baseInit(e,I);var n,a=this,o=a.input();a.opts(m)&&(n=t(a.opts(h)),o.after(n),t(a).data("container",n),a.on({enterKeyPress:a.onEnterKeyPress,backspaceKeyDown:a.onBackspaceKeyDown,preInvalidate:a.onPreInvalidate,postInit:a.onPostInit,getFormData:a.onGetFormData}),a.on(n,{click:a.onClick,mousemove:a.onContainerMouseMove}),a.on(o,{mousemove:a.onInputMouseMove})),a._originalPadding={left:parseInt(o.css("paddingLeft")||0),top:parseInt(o.css("paddingTop")||0)},a._paddingBox={left:0,top:0},a.updateFormCache()},n.containerElement=function(){return t(this).data("container")},n.onPostInit=function(t){var e=this;e.addTags(e.opts(p))},n.onGetFormData=function(t,e,n){var a=this,o=13===n?"":a.val(),i=a._formData;e[200]=a.formDataObject(o,i)},n.initPriority=function(){return 100},n.onInputMouseMove=function(t){this.toggleZIndex(t)},n.onContainerMouseMove=function(t){this.toggleZIndex(t)},n.onBackspaceKeyDown=function(t){var e=this,n=e.tagElements().last();0==e.val().length&&e.removeTag(n)},n.onPreInvalidate=function(t){var e=this,n=e.tagElements().last(),a=n.position();n.length>0?a.left+=n.innerWidth():a=e._originalPadding,e._paddingBox=a,e.input().css({paddingLeft:a.left,paddingTop:a.top})},n.onClick=function(e){function n(t,e){a.data(s,t),a.find(c).text(o.itemManager().itemToString(t)),o.updateFormCache(),i.getFormData(),i.invalidateBounds(),e&&i.focusInput()}var a,o=this,i=o.core(),l=t(e.target),d=0;l.is(g)?d=1:l.is(f)?(o.removeTag(l.parents(r+":first")),d=1):l.is(c)&&(a=l.parents(r+":first"),o.trigger(T,a,a.data(s),n)),d&&i.focusInput()},n.onEnterKeyPress=function(t){var e=this,n=e.val(),a=e.itemManager().stringToItem(n);e.isTagAllowed(a)&&(e.addTags([a]),e.core().focusInput())},n.updateFormCache=function(){var e=this,n=[];e.tagElements().each(function(){n.push(t(this).data(s))}),e._formData=n},n.toggleZIndex=function(t){var e=this,n=e.input().offset(),a=t.clientX-n.left,s=t.clientY-n.top,r=e._paddingBox,l=e.containerElement(),g=l.is(i),d=a>r.left&&s>r.top;(!g&&!d||g&&d)&&l[(g?"remove":"add")+"Class"](o)},n.tagElements=function(){return this.containerElement().find(r)},n.isTagAllowed=function(t){var e={tag:t,result:!0};return this.trigger(x,e),e.result===!0},n.addTags=function(t){if(t&&0!=t.length){var e,n,a=this,o=a.core(),i=a.containerElement();for(e=0;e<t.length;e++)n=t[e],n&&a.isTagAllowed(n)&&i.append(a.renderTag(n));a.updateFormCache(),o.getFormData(),o.invalidateBounds()}},n.getTagElement=function(e){var n,a,o=this,i=o.tagElements();for(n=0;n<i.length;n++)if(a=t(i[n]),o.itemManager().compareItems(a.data(s),e))return a;return null},n.removeTag=function(e){var n,a=this,o=a.core();if(e instanceof t)n=e,e=e.data(s);else if(n=a.getTagElement(e),null===n)return;n.remove(),a.updateFormCache(),o.getFormData(),o.invalidateBounds()},n.renderTag=function(e){var n=this,a=t(n.opts(v));return a.find(".text-label").text(n.itemManager().itemToString(e)),a.data(s,e),a}})(jQuery);