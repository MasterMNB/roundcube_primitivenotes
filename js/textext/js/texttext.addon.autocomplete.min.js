(function(e){function t(){}e.fn.textext.TextExtAutocomplete=t,e.fn.textext.addPlugin("autocomplete",t);var n=t.prototype,o=".",i="text-selected",s=o+i,r="text-suggestion",a=o+r,l="text-label",g=o+l,u="autocomplete.enabled",c="autocomplete.dropdown.position",d="autocomplete.dropdown.maxHeight",p="autocomplete.render",h="html.dropdown",m="html.suggestion",w="hideDropdown",f="showDropdown",v="getSuggestions",D="above",S="below",E="mousedownOnAutocomplete",y={autocomplete:{enabled:!0,dropdown:{position:S,maxHeight:"100px"}},html:{dropdown:'<div class="text-dropdown"><div class="text-list"/></div>',suggestion:'<div class="text-suggestion"><span class="text-label"/></div>'}};n.init=function(t){var n=this;n.baseInit(t,y);var o,i=n.input();n.opts(u)===!0&&(n.on({blur:n.onBlur,anyKeyUp:n.onAnyKeyUp,deleteKeyUp:n.onAnyKeyUp,backspaceKeyPress:n.onBackspaceKeyPress,enterKeyPress:n.onEnterKeyPress,escapeKeyPress:n.onEscapeKeyPress,setSuggestions:n.onSetSuggestions,showDropdown:n.onShowDropdown,hideDropdown:n.onHideDropdown,toggleDropdown:n.onToggleDropdown,postInvalidate:n.positionDropdown,getFormData:n.onGetFormData,downKeyDown:n.onDownKeyDown,upKeyDown:n.onUpKeyDown}),o=e(n.opts(h)),o.insertAfter(i),n.on(o,{mouseover:n.onMouseOver,mousedown:n.onMouseDown,click:n.onClick}),o.css("maxHeight",n.opts(d)).addClass("text-position-"+n.opts(c)),e(n).data("container",o),e(document.body).click(function(e){n.isDropdownVisible()&&!n.withinWrapElement(e.target)&&n.trigger(w)}),n.positionDropdown())},n.containerElement=function(){return e(this).data("container")},n.onMouseOver=function(t){var n=this,o=e(t.target);o.is(a)&&(n.clearSelected(),o.addClass(i))},n.onMouseDown=function(e){this.containerElement().data(E,!0)},n.onClick=function(t){var n=this,o=e(t.target);(o.is(a)||o.is(g))&&n.trigger("enterKeyPress"),n.core().hasPlugin("tags")&&n.val("")},n.onBlur=function(e){var t=this,n=t.containerElement(),o=n.data(E)===!0;t.isDropdownVisible()&&(o?t.core().focusInput():t.trigger(w)),n.removeData(E)},n.onBackspaceKeyPress=function(e){var t=this,n=t.val().length>0;(n||t.isDropdownVisible())&&t.getSuggestions()},n.onAnyKeyUp=function(e,t){var n=this,o=null!=n.opts("keys."+t);n.val().length>0&&!o&&n.getSuggestions()},n.onDownKeyDown=function(e){var t=this;t.isDropdownVisible()?t.toggleNextSuggestion():t.getSuggestions()},n.onUpKeyDown=function(e){this.togglePreviousSuggestion()},n.onEnterKeyPress=function(e){var t=this;t.isDropdownVisible()&&t.selectFromDropdown()},n.onEscapeKeyPress=function(e){var t=this;t.isDropdownVisible()&&t.trigger(w)},n.positionDropdown=function(){var e=this,t=e.containerElement(),n=e.opts(c),o=e.core().wrapElement().outerHeight(),i={};i[n===D?"bottom":"top"]=o+"px",t.css(i)},n.suggestionElements=function(){return this.containerElement().find(a)},n.setSelectedSuggestion=function(t){if(t){var n,o,s=this,a=s.suggestionElements(),l=a.first();for(s.clearSelected(),o=0;o<a.length;o++)if(n=e(a[o]),s.itemManager().compareItems(n.data(r),t)){l=n.addClass(i);break}l.addClass(i),s.scrollSuggestionIntoView(l)}},n.selectedSuggestionElement=function(){return this.suggestionElements().filter(s).first()},n.isDropdownVisible=function(){return this.containerElement().is(":visible")===!0},n.onGetFormData=function(e,t,n){var o=this,i=o.val(),s=i,r=i;t[100]=o.formDataObject(s,r)},n.initPriority=function(){return 200},n.onHideDropdown=function(e){this.hideDropdown()},n.onToggleDropdown=function(e){var t=this;t.trigger(t.containerElement().is(":visible")?w:f)},n.onShowDropdown=function(t,n){var o=this,i=o.selectedSuggestionElement().data(r),s=o._suggestions;return s?(e.isFunction(n)?n(o):(o.renderSuggestions(o._suggestions),o.toggleNextSuggestion()),o.showDropdown(o.containerElement()),void o.setSelectedSuggestion(i)):o.trigger(v)},n.onSetSuggestions=function(e,t){var n=this,o=n._suggestions=t.result;t.showHideDropdown!==!1&&n.trigger(null===o||0===o.length?w:f)},n.getSuggestions=function(){var e=this,t=e.val();e._previousInputValue!=t&&(""==t&&(current=null),e._previousInputValue=t,e.trigger(v,{query:t}))},n.clearItems=function(){this.containerElement().find(".text-list").children().remove()},n.renderSuggestions=function(t){var n=this;n.clearItems(),e.each(t||[],function(e,t){n.addSuggestion(t)})},n.showDropdown=function(){this.containerElement().show()},n.hideDropdown=function(){var e=this,t=e.containerElement();e._previousInputValue=null,t.hide()},n.addSuggestion=function(e){var t=this,n=t.opts(p),o=t.addDropdownItem(n?n.call(t,e):t.itemManager().itemToString(e));o.data(r,e)},n.addDropdownItem=function(t){var n=this,o=n.containerElement().find(".text-list"),i=e(n.opts(m));return i.find(".text-label").html(t),o.append(i),i},n.clearSelected=function(){this.suggestionElements().removeClass(i)},n.toggleNextSuggestion=function(){var e,t=this,n=t.selectedSuggestionElement();n.length>0?(e=n.next(),e.length>0&&n.removeClass(i)):e=t.suggestionElements().first(),e.addClass(i),t.scrollSuggestionIntoView(e)},n.togglePreviousSuggestion=function(){var e=this,t=e.selectedSuggestionElement(),n=t.prev();0!=n.length&&(e.clearSelected(),n.addClass(i),e.scrollSuggestionIntoView(n))},n.scrollSuggestionIntoView=function(e){var t=e.outerHeight(),n=this.containerElement(),o=n.innerHeight(),i=n.scrollTop(),s=(e.position()||{}).top,r=null,a=parseInt(n.css("paddingTop"));null!=s&&(s+t>o&&(r=s+i+t-o+a),s<0&&(r=s+i-a),null!=r&&n.scrollTop(r))},n.selectFromDropdown=function(){var e=this,t=e.selectedSuggestionElement().data(r);t&&(e.val(e.itemManager().itemToString(t)),e.core().getFormData()),e.trigger(w)},n.withinWrapElement=function(e){return this.core().wrapElement().find(e).size()>0}})(jQuery);